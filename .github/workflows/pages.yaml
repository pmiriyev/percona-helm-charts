name: Publish Helm Charts

on:
  push:
    branches:
      - publish

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - name: Check Out Repo
      uses: actions/checkout@v2

    - name: Configure Git
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"

    - name: Install Helm
      run: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

    - name: Package Helm Charts
      run: |
        mkdir ./chart-packages
        helm package charts/pmm --destination ./chart-packages

    - name: Publish Helm Charts
      run: |
        git fetch origin gh-pages
        git checkout gh-pages
        mkdir -p charts
        mv ./chart-packages/* charts/
        helm repo index charts/ --url https://pmiriyev.github.io/percona-helm-charts/
        git add charts/
        git commit -m "Publish Helm charts"
        git push origin gh-pages

###
# first create gh-pages branch
# 
# git checkout --orphan gh-pages
# git rm -rf .
# echo "Helm Chart Repository" > README.md
# git add README.md
# git commit -m "Initial commit for gh-pages branch"
# git push origin gh-pages
# 
# on repo settings, enable pages and choose to deploy from branch, choose br gh-pages and folder /root
# on actions tab, choose workflow permissions, check read and write permissions